<html>
	
	<head>
	  <meta charset="utf-8">
	  <meta name="viewport" content="width=device-width" />
	  <title>iCalcio 2.0</title>
	  <!-- <link rel="stylesheet" type="text/css" href="index.css"> -->

	  <!-- JQuery -->
	  

	 <!-- <script src="index.js"></script> -->

	  <!-- Bootstrap -->
    <!--script src="js/bootstrap.min.js"></script> -->

    <!-- JS-->
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="jquery.bpopup.min.js"></script>
	<script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
	<script src="https://cdn.datatables.net/1.10.16/js/dataTables.foundation.min.js"></script>
	<!-- <script src="https://cdn.datatables.net/1.10.16/js/dataTables.bootstrap.min.js"></script> -->
	<script src="https://cdn.datatables.net/responsive/2.2.1/js/dataTables.responsive.min.js"></script>
	<!-- <script src="https://cdn.datatables.net/responsive/2.2.1/js/responsive.bootstrap.min.js"></script> -->
	<script src="https://cdn.datatables.net/responsive/2.2.1/js/responsive.foundation.min.js"></script>

	<!-- CSS-->
	<!-- <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" rel="stylesheet"> -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.4.3/css/foundation.min.css" rel="stylesheet">
    <!-- <link href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" rel="stylesheet"> -->
    <!-- <link href="https://cdn.datatables.net/1.10.16/css/dataTables.bootstrap.min.css" rel="stylesheet"> -->  
    <link href="https://cdn.datatables.net/1.10.16/css/dataTables.foundation.min.css" rel="stylesheet">  
    <!-- <link href="https://cdn.datatables.net/responsive/2.1.1/css/responsive.bootstrap.min.css" rel="stylesheet"> -->
    <link href="https://cdn.datatables.net/responsive/2.2.1/css/responsive.foundation.min.css" rel="stylesheet">

    <!-- Responsive -->    
    <link href="https://cdn.datatables.net/responsive/2.2.1/css/responsive.dataTables.min.css" rel="stylesheet">
    
    
    <style type="text/css">
    	.disqual {
		text-decoration: line-through;	
		}
		.injured {
		text-decoration: line-through;	
		}
		.italic {
		font-style: italic;	
		}
		.capitan {
		font-weight: bold;
		}
		.starr {
		display: inline-block;
		background-image: url("http://s5o.ru/common/css/i/onlines/inferno.png");
		}
		img {
		width: 70%; 
		height: 70%;
		}
		.small_table {
		font-family: "Lucida Sans Unicode", "Lucida Grande", Sans-Serif;
		font-size: 13px;
		border-radius: 10px;
		border-spacing: 0;
		/*text-align: center;*/
		/*table-layout:fixed;*/
		}
		/*.small_table th {
		background: #6699ff;
		color: white;
		text-shadow: 0 1px 1px #2D2020;
		padding: 10px 20px;
		}*/
		.small_table tr.in_a_row {
		background: #bbff99;	
		}
		.small_table tr.not_in_a_row {
		background: #ffcce6;	
		}

    </style>

    <!-- Select -->
    <!--link href="https://cdn.datatables.net/select/1.2.5/css/select.dataTables.min.css" rel="stylesheet">    
    <script src="https://cdn.datatables.net/select/1.2.5/js/dataTables.select.min.js"></script-->	  
	

	</head>
	
	<body>

		<select id="tours">
			<option value="0">12</option>
			<option value="0">13</option>
			<option value="0">14</option>
			<option value="0">15</option>
			<option value="0">16</option>
			<option value="0">17</option>
			<option value="0">18</option>
			<option value="0">19</option>
			<option value="0">20</option>
			<option value="0">21</option>
			<option value="0">22</option>
			<option value="0">23</option>
			<option value="0">24</option>
			<option value="0">25</option>
			<option value="0">26</option>
			<option value="0">27</option>
			<option value="0">28</option>
			<option value="0">29</option>
			<option value="0">30</option>
			<option selected="selected" value="1">31</option>
			<option value="3">32</option>
			<option value="3">33</option>
			<option value="3">34</option>
			<option value="3">35</option>
			<option value="3">36</option>
			<option value="3">37</option>
			<option value="3">38</option>
		</select>

		<input type="button" value="Обновить" id="runButton">

		<!-- <table id="example" class="stripe row-border order-column" cellspacing="1" width="80%"> -->
		<table id="example" class="display responsive nowrap" style="width:100%">			
			<thead>
	            <tr>
	                <th>Участник</th>
	                <th>Тур</th>
	                <th>ОТ</th>
	                <!-- <th>ОС</th> -->
	            </tr>
	        </thead>			
    	</table>	

    	<div id="tables" style="display: none;">
 		</div>

	    <script type="text/javascript">
			var tour = $("#tours :selected").text();
			var tourName = parseInt('8315') + parseInt(tour);
			console.log(tourName);
			$('#runButton').click(function() {
				$("#tables").empty();
				tour = $("#tours :selected").text();
				tourName = parseInt('8315') + parseInt(tour);
				console.log(tourName);
			    runFantasy('' + tourName, '');
			});			
		</script>

		<script type="text/javascript">
			
			var data_football = [
 						['PrincipessaMilana', '0','0'],
						['ymat', '0','0'],
						['xheo', '0','0'],
						['busotir', '0','0'],
						['pr-positive', '0','0'],
						['Евгений', '0','0']
					];					
		</script>

		<script type="text/javascript">
			function updateCell(cellNum, userName, value) {
				var table = $('#example').DataTable();
				table.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
				   var data = this.data();
				   if(data[0] == userName)
				   		data[parseInt(cellNum)] = value;
				   this.data(data);
				});
			}
			function orderTable() {
				var table = $('#example').DataTable();
				table
				    .order( [ 2, 'desc' ] )
				    .draw();
			}
		</script>

		<script type="text/javascript">
			$.YQL = function(query, callback) {

		    if (!query || !callback) {
		        throw new Error('$.YQL(): Parameters may be undefined');
		    }

		    var encodedQuery = encodeURIComponent(query.toLowerCase()),
		        url = 'https://query.yahooapis.com/v1/public/yql?q=' +
		        encodedQuery + '&format=json&callback=?';		  

		    $.getJSON(url, callback);
			};
		</script>

		<script type="text/javascript">
			function getUnixTs() {
			    var ts = Math.round((new Date()).getTime() / 1000).toString();
			    ts = ts.slice(0, -1);
			    return ts;
			}
		</script>

		<script type="text/javascript">
		function runFantasy(tourId, userName) {
			var teams = 
			   [{userId: "1890113", name: "xheo", result: 0}, 
				{userId: "1892071", name: "pr-positive", result: 0},
				{userId: "1895810", name: "busotir", result: 0},
				{userId: "1889520", name: "Евгений", result: 0},
				{userId: "1892171", name: "PrincipessaMilana", result: 0},
				{userId: "1892280", name: "ymat", result: 0}];
			var ids = 0;
			var SportsRuUrlTemplate = "https://www.sports.ru/fantasy/football/team/points/";
			var JsonUrlTemplate = ".json";

				for (ids = 0; ids < teams.length; ids++) 
				{
				   (function(ids) {
				   	if (userName != '' && userName != teams[ids].name)
				   	{
				   		return;
				   	}
					var json_url = SportsRuUrlTemplate + teams[ids].userId + "/" + tourId + JsonUrlTemplate;
					console.log(json_url);
					$.YQL("SELECT * FROM json WHERE url='" + json_url + '?_=' + getUnixTs() + "' LIMIT 1", function(response){
						
						var json = response.query.results.json;
						
						var MIN_GOALKEEPER_COUNT = 1, MIN_DEFENDER_COUNT = 3, MIN_HALFBACK_COUNT = 2, MIN_FORWARD_COUNT = 1;

						var Goalkeepers = [], Defenders = [], Halfbacks = [], Forwards = [], Other = [], Bench = [];
				
						var need_goalkeepers = 0, need_defenders = 0, need_halfbacks = 0, need_forwards = 0;
					
						var Positions = [Goalkeepers, Defenders, Halfbacks, Forwards, Bench, Other];
						var PositionsHTML = ["Вр", "Защ", "Пз", "Нап", "Зап", "n/a"];
				
						for (var i = 0; i < json.players.length; i++) 
						{
							if (json.players[i].points != '-') 
								if (json.players[i].row != 0)
									Positions[Number(json.players[i].amplua)-1].push(json.players[i]);
								else
									Positions[4].push(json.players[i]);
							else 
								Positions[5].push(json.players[i]);
						}
					
						if (Goalkeepers.length < MIN_GOALKEEPER_COUNT) need_goalkeepers = MIN_GOALKEEPER_COUNT - Goalkeepers.length;
						if (Defenders.length < MIN_DEFENDER_COUNT) need_defenders = MIN_DEFENDER_COUNT - Defenders.length;
						if (Halfbacks.length < MIN_HALFBACK_COUNT) need_halfbacks = MIN_HALFBACK_COUNT - Halfbacks.length;
						if (Forwards.length < MIN_FORWARD_COUNT) need_forwards = MIN_FORWARD_COUNT - Forwards.length;
					
						// К примеру, need_defenders = 2 означает, что нам необходимо найти в массиве Bench
						// 2 защитника, у которых не "-" количество очков
					
						var needings = [need_goalkeepers, need_defenders, need_halfbacks, need_forwards];
					
						for (var need = 0; need < needings.length; need++)
						{
							if (needings[need] > 0)
							{
								for (i = 0; i < Bench.length; i++)
								{
									if (Bench[i].amplua != 1)
									{
										if (needings[need] > 0)
										{
											Positions[need].push(Bench[i]);
											Bench.splice(i, 1);
											needings[need]--;
										}
									}
								}
							}
						}
					
						// Допустим, чисто технически замены не нужны, но в команде некомплект
						// Нужно накинуть столько игроков, сколько не хватает до 11ти
						// из тех, кто остался на скамейке

						var need_to_be_completed = 11 - (Goalkeepers.length + Defenders.length + Halfbacks.length + Forwards.length);
						/*console.log("Need To be completed: " + need_to_be_completed + ": for " + teams[ids].name + 
						    + Number(Goalkeepers.length) + Number(Defenders.length) +
						    Number(Halfbacks.length) + Number(Forwards.length));*/
						if (need_to_be_completed > 0 && (need_defenders == 0 || need_halfbacks == 0 || need_forwards == 0))
						{
							for (i = 0; i < Bench.length; i++)
							{
								if (Bench[i].amplua != 1) // Это не должен быть вратарь
								{
									if (need_to_be_completed > 0)
									{
										if (Bench[i].amplua == 2) Defenders.push(Bench[i]);
										else if (Bench[i].amplua == 3) Halfbacks.push(Bench[i]);
										else if (Bench[i].amplua == 4) Forwards.push(Bench[i]);
										Bench.splice(i, 1);
										need_to_be_completed--;
									}
								}
							}
						}
				
						var points = 0;
						var tr_class;
						var teamName = teams[ids].name;	
						var res = teams[ids].result;
						//var content = '<div class=' + teamName +'><h3 class="spoiler-title" id="' + teamName + '">' + teamName + "    ...loading..." + '</h3>'
						var content = '<div class=' + teamName + '>';
						content += '<table class="small_table"';
						content += " border='0'><tr><th>Клуб</th><th>Имя</th><th>Поз</th><th>О</th><th>Г</th><th>П</th><th>Мин</th><th>ЖК</th><th>КК</th></tr>";
						for (var pos = 0; pos < Positions.length; pos++)
						{
							for (i = 0; i < Positions[pos].length; i++)
							{
								if (Positions[pos] != Bench && Positions[pos] != Other)
								{
									points += parseInt(Positions[pos][i].points);
									var tr_class = "in_a_row";
								}
								else
								{
									var tr_class = "not_in_a_row";
								}
									
								content += '<tr class="'
								if (Number(Positions[pos][i].isCaptain) != 0) 
									content += 'capitan '; 
								if (Number(Positions[pos][i].is_disqual) != 0) 
									content += 'disqual '; 
								if (Number(Positions[pos][i].is_injured) != 0) 
									content += 'injured '; 
								if (Number(Positions[pos][i].row) == 0) 
									content += 'italic '; 
								content += tr_class + '">'
								content += '<td>';
								content += '<img ';
								if (Positions[pos][i].is_star == 1) content += 'class=starr';
								content += ' src="' + Positions[pos][i].img + '">';
								content += '</td>';
								content += '<td class="name">' + Positions[pos][i].name + '</td>';
								content += '<td>' + PositionsHTML[Number(Positions[pos][i].amplua)-1] + '</td>';
								content += '<td>' + Positions[pos][i].points + '</td>';
								if (Number(Positions[pos][i].amplua) == 1)
									content += '<td>' + Number(Positions[pos][i].thru)*(-1) + '</td>';
								else	
									content += '<td>' + Positions[pos][i].goals + '</td>';
								content += '<td>' + Positions[pos][i].pass + '</td>';
								content += '<td>' + Positions[pos][i].min + '</td>';
								content += '<td>' + Positions[pos][i].ycard + '</td>';
								content += '<td>' + Positions[pos][i].rcard + '</td>';
								content += '</tr>';
							}
						}
						
						content += "</table></div>";
						//$("#animation_"+teamName).hide();
						$('#tables').append(content);
						//$('.spoiler-title' + '#' + teamName).text(teamName + " = " + points + " (" + Number(Number(res)+Number(points)) + ")");
						updateCell(1, teamName, tour);
						updateCell(2, teamName, points);
						orderTable();
						console.log(ids + " " + teamName + " " + points);
						}
			        );
				})(ids);
			}
		   }
		</script>

		<script> 
    		var table = $('#example').DataTable( {
				        "data": data_football,
				        /*"columnDefs": [
    						{ "width": "25%", "targets": 0 },
    						{ "width": "10%", "targets": 1 },
    						{ "width": "10%", "targets": 2 },
    						{ "width": "10%", "targets": 3 }
    					],*/
				        "order": [[ 2, "desc" ]],			        
				        "ordering": true,
				        "info":     false,
				        "paging":   false,
				        "searching": false,
				        "responsive": true,
	        			"stateSave": false,
				        "select": true
				 });
			runFantasy('' + tourName, '');
		</script>

		<script>
			    var table = $('#example').DataTable();
			     
			    $('#example tbody').on('click', 'tr', function () {
			        var data = table.row( this ).data();
			        runFantasy('' + tourName, data[0]);
			        $('.' + data[0]).bPopup({
		            follow: [false, false], //x, y
		            position: [5, 5] //x, y
		        	});
		        	$('.' + data[0]).click(function(){
					    $('.' + data[0]).remove();
					    $('.b-modal').remove();
					});
			    });

		</script>		

	</body>

	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111520620-3"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'UA-111520620-3');
	</script>
	
	
</html>
